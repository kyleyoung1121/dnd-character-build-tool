import"../chunks/DsnmJJEf.js";import"../chunks/CLB9eUYX.js";import{h as he,C as be,k as Ce,E as Se,b2 as _e,b3 as $e,e as we,v as U,b4 as ye,b5 as Ee,aI as Te,y as A,W as ae,X as L,Y as F,Z as le,a0 as S,$,_ as N,au as re,d as C,ar as X,as as ke,ay as qe,j as Be,z as Re}from"../chunks/rn6nHgdH.js";import{b as Pe,c as ie,w as Ne,a as G,e as Ae,g as z}from"../chunks/ZJQv4x7Q.js";import{i as De}from"../chunks/Co363syM.js";import{e as ce,i as Oe}from"../chunks/CAQU5EIs.js";import{s as xe}from"../chunks/BXwS9YYZ.js";import{s as ue}from"../chunks/CHpWTfCS.js";import{i as pe}from"../chunks/hD6VUnFp.js";import{s as fe,a as H}from"../chunks/Cb9z2JfB.js";import{b as E}from"../chunks/CI2IoGDg.js";import{s as Ie}from"../chunks/BviLQlk-.js";import{c as Fe,a as de,v as Le,m as Z}from"../chunks/2B6LwRL0.js";import{c as V,a as We,g as ze,h as Q}from"../chunks/CIqA3WZi.js";import{a as ve}from"../chunks/Dnzb4z2X.js";import{g as je,w as Ue,s as Ge,e as He,r as Ve,p as Me,m as Ke,d as Ye,c as Je,a as Xe,b as Ze,f as Qe}from"../chunks/BH-lYZvk.js";import{d as es}from"../chunks/BbUdCK9o.js";function ss(s,e,o,a,t){he&&be();var l=e.$$slots?.[o],i=!1;l===!0&&(l=e.children,i=!0),l===void 0||l(s,i?()=>a:a)}const ns=()=>performance.now(),w={tick:s=>requestAnimationFrame(s),now:()=>ns(),tasks:new Set};function ge(){const s=w.now();w.tasks.forEach(e=>{e.c(s)||(w.tasks.delete(e),e.f())}),w.tasks.size!==0&&w.tick(ge)}function os(s){let e;return w.tasks.size===0&&w.tick(ge),{promise:new Promise(o=>{w.tasks.add(e={c:s,f:o})}),abort(){w.tasks.delete(e)}}}function j(s,e){ie(()=>{s.dispatchEvent(new CustomEvent(e))})}function ts(s){if(s==="float")return"cssFloat";if(s==="offset")return"cssOffset";if(s.startsWith("--"))return s;const e=s.split("-");return e.length===1?e[0]:e[0]+e.slice(1).map(o=>o[0].toUpperCase()+o.slice(1)).join("")}function ee(s){const e={},o=s.split(";");for(const a of o){const[t,l]=a.split(":");if(!t||l===void 0)break;const i=ts(t.trim());e[i]=l.trim()}return e}const as=s=>s;function ls(s,e,o,a){var t=(s&ye)!==0,l="both",i,p=e.inert,g=e.style.overflow,u,n;function r(){return ie(()=>i??=o()(e,a?.()??{},{direction:l}))}var f={is_global:t,in(){e.inert=p,j(e,"introstart"),u=K(e,r(),n,1,()=>{j(e,"introend"),u?.abort(),u=i=void 0,e.style.overflow=g})},out(c){e.inert=!0,j(e,"outrostart"),n=K(e,r(),u,0,()=>{j(e,"outroend"),c?.()})},stop:()=>{u?.abort(),n?.abort()}},m=Ce;if((m.transitions??=[]).push(f),Pe){var h=t;if(!h){for(var d=m.parent;d&&(d.f&Se)!==0;)for(;(d=d.parent)&&(d.f&_e)===0;);h=!d||(d.f&$e)!==0}h&&we(()=>{U(()=>f.in())})}}function K(s,e,o,a,t){var l=a===1;if(Ee(e)){var i,p=!1;return Te(()=>{if(!p){var c=e({direction:l?"in":"out"});i=K(s,c,o,a,t)}}),{abort:()=>{p=!0,i?.abort()},deactivate:()=>i.deactivate(),reset:()=>i.reset(),t:()=>i.t()}}if(o?.deactivate(),!e?.duration)return t(),{abort:A,deactivate:A,reset:A,t:()=>a};const{delay:g=0,css:u,tick:n,easing:r=as}=e;var f=[];if(l&&o===void 0&&(n&&n(0,1),u)){var m=ee(u(0,1));f.push(m,m)}var h=()=>1-a,d=s.animate(f,{duration:g,fill:"forwards"});return d.onfinish=()=>{d.cancel();var c=o?.t()??1-a;o?.abort();var v=a-c,b=e.duration*Math.abs(v),_=[];if(b>0){var T=!1;if(u)for(var k=Math.ceil(b/16.666666666666668),q=0;q<=k;q+=1){var W=c+v*r(q/k),y=ee(u(W,1-W));_.push(y),T||=y.overflow==="hidden"}T&&(s.style.overflow="hidden"),h=()=>{var R=d.currentTime;return c+v*r(R/b)},n&&os(()=>{if(d.playState!=="running")return!1;var R=h();return n(R,1-R),!0})}d=s.animate(_,{duration:b,fill:"forwards"}),d.onfinish=()=>{h=()=>a,n?.(a,1-a),t()}},{abort:()=>{d&&(d.cancel(),d.effect=null,d.onfinish=A)},deactivate:()=>{t=A},reset:()=>{a===0&&n?.(1,0)},t:()=>h()}}const rs=()=>{const s=Ie;return{page:{subscribe:s.page.subscribe},navigating:{subscribe:s.navigating.subscribe},updated:s.updated}},is={subscribe(s){return rs().page.subscribe(s)}},J=Ne([]);let cs=0;function Y(s,e,o,a=5e3){const t=`notification-${++cs}`,l={id:t,type:s,title:e,message:o,duration:a,timestamp:Date.now()};return J.update(i=>[...i,l]),a>0&&setTimeout(()=>{me(t)},a),t}function me(s){J.update(e=>e.filter(o=>o.id!==s))}function us(s){const e=s-1;return e*e*e+1}function se(s){const e=typeof s=="string"&&s.match(/^\s*(-?[\d.]+)([^\s]*)\s*$/);return e?[parseFloat(e[1]),e[2]||"px"]:[s,"px"]}function ps(s,{delay:e=0,duration:o=400,easing:a=us,x:t=0,y:l=0,opacity:i=0}={}){const p=getComputedStyle(s),g=+p.opacity,u=p.transform==="none"?"":p.transform,n=g*(1-i),[r,f]=se(t),[m,h]=se(l);return{delay:e,duration:o,easing:a,css:(d,c)=>`
			transform: ${u} translate(${(1-d)*r}${f}, ${(1-d)*m}${h});
			opacity: ${g-n*c}`}}var fs=L('<div><div class="toast-content svelte-1nfeln3"><div class="toast-header svelte-1nfeln3"><span class="toast-icon svelte-1nfeln3"> </span> <h4 class="toast-title svelte-1nfeln3"> </h4> <button class="toast-close svelte-1nfeln3" aria-label="Close notification">×</button></div> <p class="toast-message svelte-1nfeln3"> </p></div></div>'),ds=L('<div class="toast-container svelte-1nfeln3"></div>');function vs(s,e){ae(e,!1);const[o,a]=fe(),t=()=>H(J,"$notifications",o);function l(u){me(u)}function i(u){switch(u){case"error":return"❌";case"warning":return"⚠️";case"info":return"⚠️";case"success":return"✅";default:return"ℹ️"}}function p(u){switch(u){case"error":return"border-red-500 bg-red-50 text-red-900";case"warning":return"border-yellow-500 bg-yellow-50 text-yellow-900";case"info":return"border-yellow-500 bg-yellow-50 text-yellow-900";case"success":return"border-green-500 bg-green-50 text-green-900";default:return"border-gray-500 bg-gray-50 text-gray-900"}}pe();var g=ds();ce(g,5,t,u=>u.id,(u,n)=>{var r=fs(),f=$(r),m=$(f),h=$(m),d=$(h,!0);S(h);var c=N(h,2),v=$(c,!0);S(c);var b=N(c,2);S(m);var _=N(m,2),T=$(_,!0);S(_),S(f),S(r),re((k,q)=>{ue(r,1,`toast ${k??""}`,"svelte-1nfeln3"),G(d,q),G(v,C(n).title),G(T,C(n).message)},[()=>p(C(n).type),()=>i(C(n).type)]),Ae("click",b,()=>l(C(n).id)),ls(3,r,()=>ps,()=>({y:-50,duration:300})),F(u,r)}),S(g),F(s,g),le(),a()}let P=null,D=null,O=null,x=null,I=null,ne=!1;function gs(){ne||(ne=!0,console.log("[Spell Cleanup] Service initialized"),V.subscribe(s=>{const e=s.class||"",o=s.subclass||"",a=s.race||"",t=s.subrace||"";let l="";if(e==="Warlock"&&s._provenance){const v=s._provenance.warlock_pact_boon;if(v){const b=v._set||v;b&&b.choice&&(l=b.choice)}}if(P===null){console.log("[Spell Cleanup] Capturing initial state:",{class:e,subclass:o,race:a,subrace:t,pactBoon:l}),P=e,D=o,O=a,x=t,I=l;return}const i=e!==P,p=o!==D,g=a!==O,u=t!==x,n=l!==I;if(!i&&!p&&!g&&!u&&!n)return;console.log("[Spell Cleanup] Change detected:",{classChanged:i,subclassChanged:p,raceChanged:g,subraceChanged:u,pactBoonChanged:n,from:{class:P,subclass:D,race:O,subrace:x,pactBoon:I},to:{class:e,subclass:o,race:a,subrace:t,pactBoon:l}});const r=P,f=D,m=O,h=x,d=I;P=e,D=o,O=a,x=t,I=l;const c=hs(s,{oldClass:r,oldSubclass:f,oldRace:m,oldSubrace:h,oldPactBoon:d,newClass:e,newSubclass:o,newRace:a,newSubrace:t,newPactBoon:l});if(e==="Warlock"&&p&&c.patronSpells.length>0){const v=c.patronSpells.join(", ");Y("info","Patron Changed",`Changing your Otherworldly Patron removed ${c.patronSpells.length} expanded spell(s) that are no longer available: ${v}. Please visit the Spells tab to select replacement spells.`,1e4)}if(e==="Warlock"&&n&&c.pactBoonSpells.length>0){const v=c.pactBoonSpells.join(", ");Y("info","Pact Boon Changed",`Changing your Pact Boon removed ${c.pactBoonSpells.length} spell(s) from your previous pact: ${v}. Please visit the Spells tab to select replacement spells if needed.`,1e4)}}))}const ms={"The Archfey":["Faerie Fire","Sleep","Calm Emotions","Phantasmal Force"],"The Fiend":["Burning Hands","Command","Blindness/Deafness","Scorching Ray"],"The Great Old One":["Dissonant Whispers","Tasha's Hideous Laughter","Detect Thoughts","Phantasmal Force"]};function hs(s,e){const o="spell_selections",a=s._provenance?.[o];if(!a)return console.log("[Spell Cleanup] No spell selections found"),{patronSpells:[],pactBoonSpells:[],otherSpells:[]};const t=a._set||a;if(!t.spells||!Array.isArray(t.spells))return console.log("[Spell Cleanup] No spells array found"),{patronSpells:[],pactBoonSpells:[],otherSpells:[]};console.log("[Spell Cleanup] Found",t.spells.length,"spells to check"),console.log("[Spell Cleanup] Current changes:",e),console.log("[Spell Cleanup] Spells before filter:",JSON.stringify(t.spells,null,2));const l=[],i=[],p=[],g=e.oldClass==="Warlock"&&e.oldSubclass?ms[e.oldSubclass]||[]:[],u=t.spells.filter(n=>{if(typeof n=="string")return console.log("[Spell Cleanup] Removing legacy format spell:",n),p.push(n),!1;if(!n||!n.name)return console.log("[Spell Cleanup] Removing invalid spell item:",n),n?.name&&p.push(n.name),!1;if(e.oldClass==="Warlock"&&e.newClass==="Warlock"&&e.oldSubclass!==e.newSubclass&&g.includes(n.name))return console.log(`[Spell Cleanup] Removing ${n.name} - patron changed: needed "${e.oldSubclass}", have "${e.newSubclass}"`),l.push(n.name),!1;if(e.oldClass==="Warlock"&&e.newClass==="Warlock"&&e.oldPactBoon!==e.newPactBoon&&e.oldPactBoon){const c=r.tabSource;if(c&&c.includes(e.oldPactBoon))return console.log(`[Spell Cleanup] Removing ${n.name} - pact boon changed: needed "${e.oldPactBoon}", have "${e.newPactBoon}"`),i.push(n.name),!1}const r=n,f=r.tabSource||"",m=!f.includes("-")&&(f==="cantrips"||f.startsWith("level")),h=f.includes(" - ")||f.includes("Domain")||f.includes("Oath")||f.includes("Circle"),d=f.includes("Elf")||f.includes("Tiefling")||f.includes("Gnome")||f.includes("Drow");if(m){if(r.charClass&&r.charClass!==e.newClass)return console.log(`[Spell Cleanup] Removing ${n.name} - class changed: needed "${r.charClass}", have "${e.newClass}"`),p.push(n.name),!1}else if(h){if(r.charClass&&r.charClass!==e.newClass)return console.log(`[Spell Cleanup] Removing ${n.name} - class changed (subclass spell): needed "${r.charClass}", have "${e.newClass}"`),p.push(n.name),!1;if(r.charSubclass&&r.charSubclass!==e.newSubclass)return console.log(`[Spell Cleanup] Removing ${n.name} - subclass changed: needed "${r.charSubclass}", have "${e.newSubclass}"`),p.push(n.name),!1}else if(d){if(r.charRace&&r.charRace!==e.newRace)return console.log(`[Spell Cleanup] Removing ${n.name} - race changed: needed "${r.charRace}", have "${e.newRace}"`),p.push(n.name),!1;if(r.charSubrace&&r.charSubrace!==e.newSubrace)return console.log(`[Spell Cleanup] Removing ${n.name} - subrace changed: needed "${r.charSubrace}", have "${e.newSubrace}"`),p.push(n.name),!1}else if(r.charClass&&r.charClass!==e.newClass)return console.log(`[Spell Cleanup] Removing ${n.name} - class changed (unknown source): needed "${r.charClass}", have "${e.newClass}"`),p.push(n.name),!1;return console.log(`[Spell Cleanup] Keeping ${n.name} - still valid`),!0});return u.length!==t.spells.length?(console.log(`[Spell Cleanup] Updating spells: ${t.spells.length} -> ${u.length} (removed ${t.spells.length-u.length})`),ve(o,{spells:u})):console.log("[Spell Cleanup] No spells removed"),{patronSpells:l,pactBoonSpells:i,otherSpells:p}}const bs={Fighter:Qe,Barbarian:Ze,Bard:Xe,Cleric:Je,Druid:Ye,Monk:Ke,Paladin:Me,Ranger:Ve,Rogue:He,Sorcerer:Ge,Warlock:Ue,Wizard:je};let B=[],oe=!1,M=null;const te=250;function Cs(){oe||(oe=!0,console.log("[Equipment Cleanup] Service initialized"),V.subscribe(s=>{const e=s.proficiencies||[];if(console.log("[Equipment Cleanup] Store update, proficiencies:",e),B.length===0&&e.length>0){console.log("[Equipment Cleanup] Capturing initial proficiencies:",e),B=[...e];return}B.length===0&&e.length===0||(M&&(console.log("[Equipment Cleanup] Clearing previous debounce timer"),clearTimeout(M)),console.log(`[Equipment Cleanup] Starting ${te}ms debounce timer`),M=setTimeout(()=>{console.log("[Equipment Cleanup] Debounce timer fired");const o=s.proficiencies||[];console.log("[Equipment Cleanup] Debounce complete, checking proficiencies:",{previous:B,latest:o});const a=B.filter(l=>!o.includes(l));if(a.length===0){console.log("[Equipment Cleanup] No proficiencies lost after debounce, no cleanup needed"),B=[...o];return}console.log("[Equipment Cleanup] Proficiencies LOST after debounce:",a);const t=Ss(s,a);if(B=[...o],t.length>0){const l=t.join(", ");Y("info","Equipment Adjusted",`Some equipment was unselected because you lost required proficiencies: ${l}. Please visit the Equipment tab to make new selections.`,1e4)}},te))}))}function Ss(s,e){const o=[];if(!s._provenance)return console.log("[Equipment Cleanup] No provenance data found"),o;const a=s.class;if(!a)return console.log("[Equipment Cleanup] No class found"),o;const t=bs[a];return t?.startingEquipment?.choices?(Object.keys(s._provenance).forEach(l=>{if(!l.startsWith("class_equipment_"))return;const i=s._provenance[l];if(!i)return;const p=i._set||i;if(p.selectedOption===void 0)return;const g=parseInt(l.replace("class_equipment_",""),10),u=t.startingEquipment.choices[g];if(!u||!u.options)return;const n=p.selectedOption,r=u.options[n];if(!r||Array.isArray(r)||!r.requires||r.requires.length===0)return;r.requires.some(m=>e.includes(m))?(console.log(`[Equipment Cleanup] Removing equipment choice ${g}: ${r.label} - requires lost proficiency from: ${r.requires.join(", ")}`),o.push(r.label),ve(l,{inventory:[],selectedOption:void 0,subChoiceSelections:{}})):console.log(`[Equipment Cleanup] Keeping equipment choice ${g}: ${r.label} - still have all required proficiencies`)}),o):(console.log("[Equipment Cleanup] No equipment data for class:",a),o)}function _s(){console.log(`=== CONFLICT DETECTION DEBUG ===
`);const s=z(V),e=z(Fe),o=z(de),a=z(Le);if(console.log("1. CHARACTER STATE:"),console.log("   Class:",s.class),console.log("   Race:",s.race,"/",s.subrace),console.log("   Skills:",s.skills),console.log("   Provenance keys:",Object.keys(s._provenance||{})),console.log(""),console.log("2. PROVENANCE DETAILS:"),s._provenance)for(const[l,i]of Object.entries(s._provenance)){const p="_set"in i?i._set:i;console.log(`   ${l}:`,p)}console.log(""),console.log("3. VISITED TABS:",Array.from(a)),console.log(""),console.log("4. RAW CONFLICTS (from detectConflicts):"),console.log("   Has conflicts:",e.hasConflicts),console.log("   Count:",e.conflicts.length),e.conflicts.length>0&&e.conflicts.forEach((l,i)=>{console.log(`   [${i}] Type: ${l.type}, Value: "${l.value}"`),console.log("       Sources:",l.sources),console.log("       Affected tabs:",l.affectedTabs)}),console.log(""),console.log("5. ACTIVE CONFLICTS (after filtering):"),console.log("   Has conflicts:",o.hasConflicts),console.log("   Count:",o.conflicts.length),console.log("   Tabs needing attention:",o.tabsNeedingAttention),console.log(""),console.log("6. MANUAL DETECTION TEST:");const t=es();return console.log("   Detected:",t.hasConflicts),console.log("   Conflicts:",t.conflicts.length),console.log("   Tabs:",t.tabsNeedingAttention),console.log(""),console.log("=== END DEBUG ==="),{character:s,conflicts:e,activeConflicts:o,visitedTabs:Array.from(a)}}typeof window<"u"&&(window.debugConflicts=_s,console.log("✅ Debug function loaded: window.debugConflicts()"));var $s=L('<span class="conflict-indicator svelte-hi5n5s" title="This tab has conflicts that need attention">⚠️</span>'),ws=L('<li class="svelte-hi5n5s"><a> <!></a></li>'),ys=L('<nav class="svelte-hi5n5s"><ul class="svelte-hi5n5s"></ul></nav> <!> <!>',1);function js(s,e){ae(e,!1);const[o,a]=fe(),t=()=>H(V,"$character_store",o),l=()=>H(is,"$page",o),i=()=>H(de,"$activeConflicts",o);gs(),Cs();const p=[{name:"Class",href:E+"/class",id:"class"},{name:"Species",href:E+"/species",id:"species"},{name:"Abilities",href:E+"/abilities",id:"abilities"},{name:"Background",href:E+"/background",id:"background"},{name:"Equipment",href:E+"/equipment",id:"equipment"},{name:"Export",href:E+"/export",id:"export"}];let g=Re(p);function u(c){const v=c.match(/\(creation\)\/([^/]+)/);return v?v[1]:null}function n(c){return i().tabsNeedingAttention.includes(c)}X(()=>(t(),Q),()=>{const c=[...p.slice(0,5)];We(t())&&c.push({name:ze(t()),href:E+"/beasts",id:"beasts"}),Q(t())&&c.push({name:"Spells",href:E+"/spells",id:"spells"}),c.push(p[5]),Be(g,c)}),X(()=>(l(),Z),()=>{if(l().route?.id){const c=u(l().route.id);c&&Z(c)}}),ke(),pe();var r=ys(),f=qe(r),m=$(f);ce(m,5,()=>C(g),Oe,(c,v)=>{var b=ws(),_=$(b);let T;var k=$(_),q=N(k);{var W=y=>{var R=$s();F(y,R)};De(q,y=>{C(v),U(()=>n(C(v).id))&&y(W)})}S(_),S(b),re(y=>{xe(_,"href",(C(v),U(()=>C(v).href))),T=ue(_,1,"svelte-hi5n5s",null,T,y),G(k,`${C(v),U(()=>C(v).name)??""} `)},[()=>({"has-conflict":n(C(v).id)})]),F(c,b)}),S(m),S(f);var h=N(f,2);vs(h,{});var d=N(h,2);ss(d,e,"default",{}),F(s,r),le(),a()}export{js as component};
